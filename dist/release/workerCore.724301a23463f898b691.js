self.webpackChunk([3],[function(t,e,r){"use strict";r.r(e),r.d(e,"MemoryPool",function(){return s});class s{constructor(t){this.byteLength=t,this.stack=[]}push(t){if(t.byteLength<this.byteLength)throw new Error(`Can't absorb buffer. byteLength must be at least ${this.byteLength}`);this.stack.push(t)}pushAll(t){for(let e=0;e<t.length;e++)this.push(t[e])}acquire(){return this.stack.pop()||new ArrayBuffer(this.byteLength)}drain(){const t=this.stack;return this.stack=[],t}}},,,,,,function(t,e,r){"use strict";r.r(e),r.d(e,"WorkerCore",function(){return u});var s=r(0),n=r(7),i=r(8);class u{constructor(t){const{chunkSizePx:{width:e,height:r}}=t.worker,u=e*r,o=n.Buffer.new(u);this.workerConfig=t.worker,this.pool=new s.MemoryPool(2*u),this.output={buffer:o,view:new Uint16Array(i.memory.buffer,o.as_ptr(),u)},this.runner=null,this.dataGen=null,this.resumeTimeout=null,this.pendingMessages=[]}onmessage(t){this.pendingMessages.push(t),this.setAlarm()}setAlarm(){null!==this.resumeTimeout&&clearTimeout(this.resumeTimeout),this.resumeTimeout=setTimeout(()=>{this.processMessages(),this.runJobs()})}processMessages(){this.pendingMessages.sort((t,e)=>e.seqNo-t.seqNo);const t=this.pendingMessages.findIndex(t=>"worker-reset"===t.type),e=t>=0?this.pendingMessages[t]:null,r=t>=0?this.pendingMessages.slice(0,t):this.pendingMessages;if(e){if("worker-reset"!==e.type)throw new Error(`Unexpected reset msg type: ${e.type}`);this.reset(e)}r.reverse(),r.forEach(t=>{if("worker-reset"===t.type)throw new Error(`Unexpected msg type: ${t.type}`);this.addJobs(t)}),this.pendingMessages=[]}reset(t){this.runner&&this.runner.free(),this.runner=n.EscapeTimeRunner.new(n.EscapeTime.new(t.escapeTime.c.re,t.escapeTime.c.im,t.escapeTime.maxIter,t.escapeTime.escapeRadius),n.Canvas.new(this.workerConfig.chunkSizePx.width,this.workerConfig.chunkSizePx.height,t.canvas.chunkDelta.re,t.canvas.chunkDelta.im,t.canvas.origin.re,t.canvas.origin.im)),this.dataGen=t.dataGen}addJobs(t){this.runner&&t.jobs.forEach(t=>{this.runner.push_job(n.CanvasRect.new(t.topLeft.re,t.topLeft.im,t.widthChunks,t.heightChunks))}),t.buffers&&this.pool.pushAll(t.buffers)}runJobs(){if(!this.runner||null===this.dataGen)return;const t=performance.now();let e=!1;for(;!(e=performance.now()-t>=this.workerConfig.pauseInterval)&&this.runner.advance();){this.runner.load(this.output.buffer);const t={re:this.runner.current_re(),im:this.runner.current_im()},e=this.pool.acquire(),r=new Uint16Array(e);for(let t=0;t<r.length&&t<this.output.view.length;t++)r[t]=this.output.view[t];const s={type:"chunk-update",chunkId:t,dataGen:this.dataGen,data:e};postMessage(s,[e])}e&&this.setAlarm()}}},function(t,e,r){"use strict";r.r(e),r.d(e,"Buffer",function(){return n}),r.d(e,"CanvasRect",function(){return i}),r.d(e,"EscapeTimeRunner",function(){return u}),r.d(e,"Canvas",function(){return o}),r.d(e,"EscapeTime",function(){return a}),r.d(e,"__wbindgen_throw",function(){return f});var s=r(8);class n{static __construct(t){return new n(t)}constructor(t){this.ptr=t}free(){const t=this.ptr;this.ptr=0,s.__wbg_buffer_free(t)}static new(t){return n.__construct(s.buffer_new(t))}as_ptr(){if(0===this.ptr)throw new Error("Attempt to use a moved value");return s.buffer_as_ptr(this.ptr)}}class i{static __construct(t){return new i(t)}constructor(t){this.ptr=t}free(){const t=this.ptr;this.ptr=0,s.__wbg_canvasrect_free(t)}static new(t,e,r,n){return i.__construct(s.canvasrect_new(t,e,r,n))}}class u{static __construct(t){return new u(t)}constructor(t){this.ptr=t}free(){const t=this.ptr;this.ptr=0,s.__wbg_escapetimerunner_free(t)}static new(t,e){const r=t.ptr;if(0===r)throw new Error("Attempt to use a moved value");t.ptr=0;const n=e.ptr;if(0===n)throw new Error("Attempt to use a moved value");return e.ptr=0,u.__construct(s.escapetimerunner_new(r,n))}push_job(t){if(0===this.ptr)throw new Error("Attempt to use a moved value");const e=t.ptr;if(0===e)throw new Error("Attempt to use a moved value");return t.ptr=0,s.escapetimerunner_push_job(this.ptr,e)}advance(){if(0===this.ptr)throw new Error("Attempt to use a moved value");return 0!==s.escapetimerunner_advance(this.ptr)}current_re(){if(0===this.ptr)throw new Error("Attempt to use a moved value");return s.escapetimerunner_current_re(this.ptr)}current_im(){if(0===this.ptr)throw new Error("Attempt to use a moved value");return s.escapetimerunner_current_im(this.ptr)}load(t){if(0===this.ptr)throw new Error("Attempt to use a moved value");return s.escapetimerunner_load(this.ptr,t.ptr)}}class o{static __construct(t){return new o(t)}constructor(t){this.ptr=t}free(){const t=this.ptr;this.ptr=0,s.__wbg_canvas_free(t)}static new(t,e,r,n,i,u){return o.__construct(s.canvas_new(t,e,r,n,i,u))}}class a{static __construct(t){return new a(t)}constructor(t){this.ptr=t}free(){const t=this.ptr;this.ptr=0,s.__wbg_escapetime_free(t)}static new(t,e,r,n){return a.__construct(s.escapetime_new(t,e,r,n))}}let c=new TextDecoder("utf-8"),h=null;function p(t,e){return c.decode((null!==h&&h.buffer===s.memory.buffer||(h=new Uint8Array(s.memory.buffer)),h).subarray(t,t+e))}function f(t,e){throw new Error(p(t,e))}},function(t,e,r){"use strict";var s=r.w[t.i];for(var n in r.r(e),s)"__webpack_init__"!=n&&(e[n]=s[n]);r(7);s.__webpack_init__()}]);
//# sourceMappingURL=workerCore.724301a23463f898b691.js.map